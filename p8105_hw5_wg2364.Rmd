---
title: "Homework 5"
author: "Wenhao Gou"
date: "2020/11/12"
output: github_document
---

```{r setup, message = F, warning = F}
knitr::opts_chunk$set(
  message = F,
  warning = F
)
library(tidyverse)
```

# Question 1:

## Include and tidy the data:

```{r Q1 include data}
homocide <- read_csv("Dataset/homicide_data/homicide-data.csv")
homocide
```

The dataset have 52,179 rows and 12 columns. There are 10 variables in the dataset:

* `uid`: a character indicate the id of the case

* `reported_date`: a number indicate the date of the case.

* `victim_last` to `victim_sex`: indicate the information of the victim (first and last name, race, age and sex). All of these variables are character. 

* `city` and `state`: two character indicate the location of the case

* `lat` and `lon`: two number indicate the latitude and longitude of the location

* `disposition` : a character indicate the disposition of the case

Next, we want to create a `city_state` variable (e.g. “Baltimore, MD”) and then summarize
within cities to obtain the total number of homicides and the number of unsolved homicides
(those for which the disposition is “Closed without arrest” or “Open/No arrest”)

```{r}
homocide <- 
  homocide %>% 
  mutate(city_state = str_c(city, state, sep = "_")) %>% 
  mutate(result = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )) 
homocide_summary <-
  homocide %>% 
  select(city_state, result) %>% 
  group_by(city_state) %>% 
  summarise(
    total_case = n(),
    total_unsolved = sum(result == "unsolved")
  )
homocide_summary
```

## Proportion test on Baltimore_MD

We can firstly define a function to do all the jobs:

```{r}
prop_test_ <- function(tibble_input){
  tibble_output <-
    tibble_input %>% 
    mutate(proptest = 
              map2(
                .x = pull(tibble_input, total_unsolved),
                .y = pull(tibble_input, total_case),
                ~prop.test(x = .x, n = .y))) %>% 
    mutate(tidytest = 
             map(
               .x = proptest, 
               ~broom::tidy(.x))) %>% 
    select(-proptest) %>% 
    unnest(tidytest) %>% 
    select(city_state, estimate, conf.low, conf.high)
  return(tibble_output)
}
```

Then, for Baltimore, MD
```{r}
homocide_summary %>%
  filter(city_state == "Baltimore_MD") %>%
  prop_test_(.) 
```

## Run the test for all the city:
```{r}
homocide_result <-
  homocide_summary %>% 
  prop_test_(.)
homocide_result
```

## The plot:
```{r}
homocide_result %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  filter(city_state != "Tulsa_AL") %>%   #Poor data with just 1 case
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


# Question 2:

## Read and tidy the data:

We can read the data by maps:

```{r}
study_data <- 
  tibble(
    names = list.files("Dataset/lda_data")) %>% 
  mutate(file_names = str_c("Dataset/lda_data/" , names)) %>% 
  mutate(content = map(.x = file_names, ~read_csv(.x))) %>% 
  select(-file_names)
study_data
```


Next, we need to tidy the dataset:

```{r}
study_data_tidy <-
  study_data %>%
    unnest(content) %>% 
  separate(names,
           into = c("arm","subject_id"),
           sep = "_") %>% 
  mutate(arm = case_when(
    arm == "con" ~ "Control",
    arm == "exp" ~ "Expose"
  )) %>% 
  mutate(subject_id = str_extract(subject_id, "^\\d{2}")) %>% 
  mutate(subject_id = as.numeric(subject_id)) %>% 
  pivot_longer(week_1:week_8,
               names_to = "week",
               values_to = "observation",
               names_prefix = "week_") %>% 
  mutate(week = as.numeric(week))
study_data_tidy
```

## Spaghetti plot 

```{r}
study_data_tidy %>%
  mutate(subject_id = as.factor(subject_id)) %>% 
  ggplot(aes(x = week, y = observation, color = subject_id)) +
  geom_point() +
  geom_line() +
  facet_grid(~arm)
```

From the plot, we can see that, there are different pattern between the control group and the expose group. For the control group, the observation tend to be fluctuate around 1.25 for 8 weeks. For the expose group, there is an increasing trend of the observation over time. 

# Question 3:

